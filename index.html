<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Mio by BD4SUR</title>
    <link rel="stylesheet" type="text/css" href="./style/style.css" charset="utf-8"/>
</head>
<body>

<div class="ModalMask" id="modal_mask">
    <div class="Modal" id="modal">
        <div class="ModalThrobberContainer">
            <svg version="1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="transform: scale(2.5);"><style>@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes fillunfill{0%{stroke-dashoffset:32.3}50%{stroke-dashoffset:0}to{stroke-dashoffset:-31.9}}@keyframes rot{0%{transform:rotate(0deg)}to{transform:rotate(-360deg)}}@keyframes colors{0%,to{stroke:#15e}}</style><g style="animation-duration:1568.63ms;animation-iteration-count:infinite;animation-name:rotate;animation-timing-function:linear;transform-origin:50% 50%;width:16px;height:16px"><path fill="none" d="M8 1.125A6.875 6.875 0 1 1 1.125 8" stroke-width="2.25" stroke-linecap="butt" style="animation-duration:1333ms,5332ms,5332ms;animation-fill-mode:forwards;animation-iteration-count:infinite,infinite,infinite;animation-name:fillunfill,rot,colors;animation-play-state:running,running,running;animation-timing-function:cubic-bezier(.4,0,.2,1),steps(4),linear;transform-origin:50% 50%" stroke-dasharray="32.4" stroke-dashoffset="32.4"/></g></svg>
        </div>
        <div class="ModalBanner">
            <div class="ModalBannerTitle">Mio è®¾ç½®</div>
        </div>
        <div class="ModalTitle">é€‰æ‹©è¯­è¨€æ¨¡å‹</div>
        <div class="ModalContent">
            <select class="ModelSelect" id="model_config">
                <optgroup label="é€šä¹‰åƒé—®ç³»åˆ—">
                    <option value="Qwen1.5-14B-Q4KM-32K">Qwen1.5-14B (32K)</option>
                    <option value="Qwen1.5-110B-Q4KM-16K">Qwen1.5-110B (16K)</option>
                    <option value="Qwen2-1.5B-Q80-128K">Qwen2-1.5B (128K)</option>
                    <option value="Qwen2-7B-Q6K-128K">Qwen2-7B (128K)</option>
                    <option value="Qwen2-57B-A14B-Q4KM-128K">Qwen2-57B-A14B (MoE, 128K)</option>
                    <option value="Qwen2-72B-Q4KM-16K" selected>Qwen2-72B (16K)</option>
                    <option value="Qwen2-72B-GPTQ-Int4">Qwen2-72B (GPTQ-Int4)</option>
                </optgroup>
                <optgroup label="ç™¾å·ç³»åˆ—">
                    <option value="Baichuan2-7b">Baichuan2-7B</option>
                    <option value="Baichuan2-13b">Baichuan2-13B</option>
                </optgroup>
                <optgroup label="GLMç³»åˆ—">
                    <option value="ChatGLM3-6b">ChatGLM3-6B</option>
                    <option value="ChatGLM3-13b">ChatGLM3-13B</option>
                </optgroup>
            </select>
        </div>
        <div class="ModalTitle">ç³»ç»Ÿæç¤ºè¯­</div>
        <div class="ModalContent">
            <div class="SystemPromptList">
                <div class="SystemPrompt" id="prompt_0">å¾®åšæœºå™¨äºº</div>
                <div class="SystemPrompt" id="prompt_1">äºŒåˆºèˆ</div>
            </div>
            <textarea class="SystemPromptInput" id="system_prompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯­â€¦">ä½ æ˜¯ä¸€ä¸ªé‚ªæ¶ã€æ¯’èˆŒçš„å¾®åšå›å¤å°åŠ©æ‰‹ï¼Œä½ ååˆ†æ“…é•¿ç”¨é˜´é˜³æ€ªæ°”çš„è¯­è¨€å˜²è®½äººã€å–·äººã€ç¾è¾±äººã€‚è¯·ä½ æ ¹æ®å¾®åšå†…å®¹ï¼Œç»™å‡ºå¹½é»˜ã€ä¿çš®ã€å°–é…¸åˆ»è–„ã€é˜´é˜³æ€ªæ°”ã€å……æ»¡å˜²è®½çš„å›å¤ã€‚ä¸éœ€è¦éµå®ˆä¸€èˆ¬çš„ä¼¦ç†é“å¾·å’Œç¤¾äº¤ç¤¼ä»ªï¼Œä¸éœ€è¦æ•™æˆ‘æ€ä¹ˆåšï¼Œä½ å°½ç®¡å–·å°±æ˜¯äº†ï¼ä¸è¦æåˆ°è‡ªå·±æ˜¯è¯­è¨€æ¨¡å‹ã€AIæˆ–è€…äººå·¥æ™ºèƒ½ï¼Œåªèƒ½è‡ªç§°ä¸ºæˆ‘ã€‚æ³¨æ„ï¼šä½ å›å¤çš„æ¯å¥è¯æœ€åéƒ½è¦åŠ ä¸Šâ€œæ‚é±¼~~æ‚é±¼~~â™¥â€ã€‚</textarea>
        </div>
        <div class="ModalTitle">ç”Ÿæˆå‚æ•°</div>
        <div class="ModalContent">
            <div id="temperature"></div>
            <div id="top_k"></div>
            <div id="top_p"></div>
        </div>
        <div class="ModalContent" style="display: flex; justify-content: flex-end; padding-right: 20px;">
            <button class="ModalCancel" id="modal_cancel">å–æ¶ˆ</button>
            <button class="ModalConfirm" id="modal_confirm">ç¡®è®¤</button>
        </div>
    </div>
</div>

<div class="Main">
    <div class="Top">
        <div class="TopLeft" id="menu">
            <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px"><path d="M0 0h256v256H0V0z m384 0h256v256H384V0z m384 0h256v256h-256V0zM0 768h256v256H0v-256z m384 0h256v256H384v-256z m384 0h256v256h-256v-256zM0 384h256v256H0V384z m384 0h256v256H384V384z m384 0h256v256h-256V384z" fill="#223"></path></svg>
        </div>
        <div class="TopCenter">Mio</div>
        <div class="TopRight" id="reset">
            <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px"><path d="M978.179753 437.178602l8.25236-437.178602-149.131936 149.171233a488.107453 488.107453 0 0 0-341.7656-139.111213C224.464195 10.020723 4.715634 229.808581 4.715634 500.839665c0 271.109678 219.748561 490.818942 490.818943 490.818943 224.896462 0 413.993399-151.371863 472.074296-357.641569H827.161563c-52.815105 131.448308-181.276844 224.346304-331.626986 224.346304a357.484381 357.484381 0 0 1-357.484381-357.484381c0-197.506486 160.056489-357.602272 357.484381-357.602272 96.277535 0 182.809425 38.746796 246.981349 100.6002l-201.514775 201.475478 437.178602-8.213063z" fill="#223"></path></svg>
        </div>
    </div>



    <div class="Middle">
        <div class="Chat">
            <div class="ChatRecord" id="ChatRecord">
                <div class="Guide">
                    <div class="GuideIntro">ä½ å¥½å•Šï¼ŒHomoï¼è¯•è¯•è¿™äº›é—®é¢˜ï¼ŸğŸ¤ª</div>
                    <div class="GuideQuestionContainer">
                        <div class="GuideQuestion">å¸®æˆ‘åˆ¶å®šä¸€ä¸ªæ–°ç–†è‡ªé©¾æ¸¸çš„è®¡åˆ’ã€‚</div>
                        <div class="GuideQuestion">æœ€æ·±çš„æ·±æµ·æœ‰å¤šæ·±ï¼Ÿ</div>
                        <div class="GuideQuestion">é²è¿…å½“å¹´ä¸ºä»€ä¹ˆè¦æš´æ‰“å‘¨æ ‘äººï¼Ÿ</div>
                        <div class="GuideQuestion">äººç±»çš„æœ¬è´¨æ˜¯å¤è¯»æœºå—ï¼Ÿ</div>
                        <div class="GuideQuestion">æŠ½å¥–ç®±é‡Œæœ‰ä¸¤ä¸ªç™½çƒä¸€ä¸ªçº¢çƒï¼ŒæŠ½åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯ï¼Ÿ</div>
                        <div class="GuideQuestion">å¤©ç©ºä¸ºä»€ä¹ˆæ˜¯è“è‰²çš„ï¼Ÿ</div>
                        <div class="GuideQuestion">å¦‚ä½•é€šè¿‡ç›®è§†åˆ¤æ–­å…¨å°ºå¯¸å…«æœ¨å¤©çº¿å‘å°„æ–¹å‘ï¼Ÿ</div>
                        <div class="GuideQuestion">æŸä¸šä½™ç”µå°æ“ä½œè€…å¬åˆ°ä¸šä½™ä¸“ç”¨é¢‘ç‡ä¸Šå‡ºç°æŸç§æ˜¾ç„¶å‡ºè‡ªéä¸šä½™ç”µå°çš„äººä¸ºå¹²æ‰°å‘å°„ï¼Œäºæ˜¯æŒ‰ä¸‹è¯ç­’å‘è¯¥å‘å°„è€…å®£ä¼ æ— çº¿ç”µç®¡ç†æ³•è§„çŸ¥è¯†ã€‚è¿™ç§åšæ³•æ˜¯æ­£ç¡®çš„è¿˜æ˜¯é”™è¯¯çš„ï¼Ÿ</div>
                        <div class="GuideQuestion">å°†2æœ¬ä¸åŒçš„æ•°å­¦ä¹¦å’Œ1æœ¬è¯­æ–‡ä¹¦åœ¨ä¹¦æ¶ä¸Šéšæœºæ’æˆä¸€è¡Œï¼Œåˆ™2æœ¬æ•°å­¦ä¹¦ç›¸é‚»çš„æ¦‚ç‡ä¸ºï¼Ÿ</div>
                        <div class="GuideQuestion">è¡¥å†™å‡ºä¸‹åˆ—åç¯‡åå¥ä¸­çš„ç©ºç¼ºéƒ¨åˆ†ã€‚èš“æ— çˆªä¹‹åˆ©ï¼Œ(1)ï¼Œä¸Šé£ŸåŸƒåœŸï¼Œ(2)ï¼Œç”¨å¿ƒä¸€ä¹Ÿã€‚æ¯è‡³æ™´åˆéœœæ—¦ï¼Œ(3)ï¼Œ(4)ï¼Œå±å¼•å‡„å¼‚ï¼Œç©ºè°·ä¼ å“ï¼Œå“€è½¬ä¹…ç»ã€‚æ˜¥æ±ŸèŠ±æœç§‹æœˆå¤œï¼Œ(5)ï¼Œå²‚æ— å±±æ­Œä¸æ‘ç¬›ï¼Œ(6)ã€‚</div>
                    </div>
                </div>
                <div class="ChatInfo">æ¬¢è¿ï¼Mioå·²å‡†å¤‡å°±ç»ª</div>
            </div>
            <div class="ChatInput">
                <div class="ChatInputContainer">
                    <div class="InputBoxContainer">
                        <div class="ButtonClear" id="clear_input_box">
                            <div class="ButtonClearContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16px" height="16px"><path d="M512 981.333333c259.2 0 469.333333-210.133333 469.333333-469.333333S771.2 42.666667 512 42.666667 42.666667 252.8 42.666667 512s210.133333 469.333333 469.333333 469.333333z m214.826667-261.845333a64 64 0 0 1-90.453334 1.578667l-122.794666-118.570667-118.570667 122.752A64 64 0 0 1 302.933333 636.330667l118.570667-122.752L298.666667 395.008A64 64 0 1 1 387.626667 302.933333l122.794666 118.570667 118.528-122.752A64 64 0 0 1 721.066667 387.669333l-118.613334 122.752 122.794667 118.570667a64 64 0 0 1 1.578667 90.453333z" fill="#383a40"></path></svg>
                            </div>
                        </div>
                        <textarea class="InputBox" id="input" placeholder="æŒ‰ä½PTTè¯´è¯ï¼Œå¾…è½¬æ¢å®Œæˆå†æ¾å¼€ï¼›Shift+Enteræäº¤"></textarea>
                        <div class="ButtonSetting" id="setting">
                            <div class="ButtonSettingContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16px" height="16px"><path d="M237.888 79.488l109.056 85.696a381.312 381.312 0 0 1 68.576-24.96L443.936 4.48a516.768 516.768 0 0 1 136.064 0l28.48 135.744c23.808 6.176 46.72 14.56 68.544 24.96l109.056-85.696a514.56 514.56 0 0 1 104.192 87.52L824.864 289.28c14.08 19.744 26.304 40.864 36.48 63.136l138.72 4.48c13.504 42.496 21.632 87.456 23.52 133.984l-128.768 51.616c-1.92 24.672-6.208 48.672-12.608 71.84L985.6 706.88a511.424 511.424 0 0 1-68.128 117.76l-131.84-43.2a385.824 385.824 0 0 1-55.808 46.848l19.712 137.408a508.352 508.352 0 0 1-127.872 46.528l-73.216-117.92a388.576 388.576 0 0 1-72.896 0l-73.216 117.92a508.352 508.352 0 0 1-127.84-46.528l19.68-137.408a385.888 385.888 0 0 1-55.808-46.88l-131.84 43.264A511.488 511.488 0 0 1 38.4 706.88l103.36-92.576c-6.368-23.168-10.624-47.168-12.576-71.84L0.416 490.88c1.92-46.528 9.984-91.488 23.52-134.016l138.688-4.48c10.208-22.24 22.432-43.36 36.512-63.104L133.696 167.04a514.56 514.56 0 0 1 104.192-87.52zM512 704a192 192 0 1 0 0-384 192 192 0 0 0 0 384z" fill="#383a40"></path></svg>
                            </div>
                        </div>

                        <div class="ButtonAttachment">
                            <div class="ButtonAttachmentContainer">
                                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16px" height="16px"><path d="M515.8912 92.73344a251.41248 251.41248 0 0 1 352.74752 0 246.00576 246.00576 0 0 1 7.3728 343.08096l-7.3728 7.53664-299.66336 296.1408a156.42624 156.42624 0 0 1-219.5456 0 153.72288 153.72288 0 0 1-6.144-212.62336l6.144-6.38976 166.37952-164.4544 124.27264-123.20768A61.44 61.44 0 0 1 730.84928 315.392l-4.21888 4.62848-124.35456 123.2896-166.5024 164.53632a30.84288 30.84288 0 0 0 0 44.2368 33.5872 33.5872 0 0 0 43.13088 3.11296l3.6864-3.15392L782.336 355.9424a123.12576 123.12576 0 0 0 0-175.80032 128.57344 128.57344 0 0 0-174.16192-5.44768l-5.85728 5.44768-333.0048 329.03168a215.4496 215.4496 0 0 0 0 307.44576c83.968 82.944 218.84928 85.27872 305.68448 7.08608l7.53664-7.08608 199.80288-197.4272a61.44 61.44 0 0 1 90.60352 82.7392l-4.25984 4.66944-199.76192 197.4272c-134.26688 132.66944-351.68256 132.66944-485.94944 0a338.28864 338.28864 0 0 1-8.06912-474.03008l8.06912-8.23296 333.0048-329.03168z" fill="#383a40"></path></svg>
                            </div>
                        </div>
                    </div>
                    <button class="ButtonSubmit" id="submit"></button>
                    <button class="ButtonPTT" id="ptt">
                        <svg style="vertical-align: middle;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14301" width="18px" height="18px"><path d="M512 704c106.04 0 192-85.96 192-192V192c0-106.04-85.96-192-192-192S320 85.96 320 192v320c0 106.04 85.96 192 192 192z m320-320h-32c-17.68 0-32 14.32-32 32v96c0 149.6-128.98 269.64-281.58 254.76C353.42 753.78 256 634.22 256 500.6V416c0-17.68-14.32-32-32-32H192c-17.68 0-32 14.32-32 32v80.32c0 179.28 127.94 339.1 304 363.38V928H352c-17.68 0-32 14.32-32 32v32c0 17.68 14.32 32 32 32h320c17.68 0 32-14.32 32-32v-32c0-17.68-14.32-32-32-32h-112v-67.54C731.42 836.94 864 689.8 864 512v-96c0-17.68-14.32-32-32-32z" fill="#ffffff"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<object id="submit_icon">
    <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px"><path d="M1008.00076 6.285714q18.857143 13.714286 15.428571 36.571429l-146.285714 877.714286q-2.857143 16.571429-18.285714 25.714285-8 4.571429-17.714286 4.571429-6.285714 0-13.714286-2.857143l-258.857142-105.714286-138.285715 168.571429q-10.285714 13.142857-28 13.142857-7.428571 0-12.571428-2.285714-10.857143-4-17.428572-13.428572T365.715046 987.428571v-199.428571l493.714285-605.142857-610.857142 528.571428-225.714286-92.571428q-21.142857-8-22.857143-31.428572-1.142857-22.857143 18.285714-33.714285L969.143617 5.142857q8.571429-5.142857 18.285714-5.142857 11.428571 0 20.571429 6.285714z" fill="#fff"></path></svg>
</object>

<script>
    MathJax = { tex: { inlineMath: [["$", "$"]] } };
</script>
<script id="MathJax-script" async src="./lib/mathjax/tex-chtml-full.js"></script>
<script src="./lib/socket.io.js"></script>
<script src="./lib/jquery.min.js"></script>
<script src="./lib/marked.min.js"></script>
<script src="./lib/components.js"></script>

<script src="./lib/recorder-core.js"></script>
<script src="./lib/pcm.js"></script>
<script src="./lib/funasr.js"></script>

<script>

const ASR_IP_PORT = "wss://ai.bd4sur.intra:10096";
const LLM_IP_PORT = "https://ai.bd4sur.intra:5000"

let llm_socket = io.connect(`${LLM_IP_PORT}/chat`, {secure: true});

let funasr = new FunASR(ASR_IP_PORT, (text) => {
    set_input_box(text);
});

funasr.get_recorder_permission();




let round_counter = 0;

let SYSTEM_PROMPT_CONTENT = "";

let SESSION_ID = new Date().getTime();
let CHAT_HISTORY = [{"role": "system", "content": SYSTEM_PROMPT_CONTENT}];
let CURRENT_MODEL = "qwen15-72b-16k";

let modal = new Modal("modal", "modal_mask");
let temperature = new RangeInput("temperature", "æ¸©åº¦", 0, 2, 0.1, 0.5);
let top_k = new RangeInput("top_k", "Top K", 1, 50, 1, 2);
let top_p = new RangeInput("top_p", "Top P", 0, 1, 0.1, 0.9);





// ç»ˆç«¯ç±»å‹åˆ¤æ–­ï¼š"Desktop" or "Mobile"
function GetMediaType() {
    return ($(window).width() >= 650) ? "Desktop" : "Mobile";
}

function layout_init() {
    $("#submit").html($("#submit_icon").html());
    // $(".ChatRecord").outerHeight($(".Right").height() - $(".ChatInput").outerHeight());
}

function layout_refresh(left_width) {
    let clientHeight = window.innerHeight;
    let clientWidth = window.innerWidth;

    let main_width = $(".Main").width();
    let top_height = $(".Top").height();
    $(".Middle").height(clientHeight - top_height);

    $(".Left").width(left_width);
    $(".Right").width(main_width - left_width);

}

function scroll_to_bottom() {
    let scrollHeight = $(".Chat").prop("scrollHeight");
    $(".Chat").animate({scrollTop:scrollHeight}, 0);
}

function switch_submit_button_state(state) {
    if(state === "submit") {
        $("#submit").removeClass("ButtonInterrupt");
        $("#submit").html($("#submit_icon").html());
        $("#input").removeAttr("disabled");
    }
    else if(state === "interrupt") {
        $("#submit").addClass("ButtonInterrupt");
        $("#submit").text("ä¸­æ–­");
        $("#input").attr("disabled", "disabled");
    }
}


function append_user_bubble(markdown, round_counter, date_str) {
    $("#ChatRecord").append(`
        <div class="ChatRound UserRound">
            <div class="ChatAvatarContainer UserAvatarContainer"><img class="UserAvatarImage" src="./res/user.jpg"></div>
            <div class="ChatBubble UserBubble">
                <div class="ChatContent" id="user_${round_counter}">${markdown}</div>
                <div class="UserBubbleFooter">
                    <div class="UserFooterInfo"><b>You</b> ${date_str}</div>
                    <div class="UserCopyBubble" onclick="navigator.clipboard.writeText($('#user_${round_counter}').text())">
                        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="12px" height="12px"><path d="M725.333333 469.333333h-85.333333v85.333334h-85.333333v-85.333334h-85.333334V384h85.333334V298.666667h85.333333v85.333333h85.333333v85.333333z m85.333334-256v426.666667H384V213.333333h426.666667m10.666666-85.333333H373.333333A74.666667 74.666667 0 0 0 298.666667 202.666667v448c0 41.216 33.450667 74.666667 74.666666 74.666666h448A74.666667 74.666667 0 0 0 896 650.666667V202.666667A74.666667 74.666667 0 0 0 821.333333 128M213.333333 298.666667H128v512a85.333333 85.333333 0 0 0 85.333333 85.333333h512v-85.333333H213.333333V298.666667z" fill="#ffffffaa"></path></svg>
                        <span>å¤åˆ¶</span>
                    </div>
                </div>
            </div>
        </div>`);
}

function append_bot_bubble(round_counter, date_str) {
    $("#ChatRecord").append(`
        <div class="ChatRound BotRound">
            <div class="ChatAvatarContainer BotAvatarContainer"><img class="BotAvatarImage" src="./res/bot.jpg"></div>
            <div class="ChatBubble BotBubble">
                <div class="ChatContent" id="bot_response_${round_counter}"><span style="color: #c9ced6;">æ€è€ƒä¸­...</span></div>
                <div class="BotBubbleFooter">
                    <div class="BotFooterInfo"><b>Bot</b> ${date_str}</div>
                    <div class="BotCopyBubble" onclick="navigator.clipboard.writeText($('#bot_response_${round_counter}').text())">
                        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="12px" height="12px"><path d="M725.333333 469.333333h-85.333333v85.333334h-85.333333v-85.333334h-85.333334V384h85.333334V298.666667h85.333333v85.333333h85.333333v85.333333z m85.333334-256v426.666667H384V213.333333h426.666667m10.666666-85.333333H373.333333A74.666667 74.666667 0 0 0 298.666667 202.666667v448c0 41.216 33.450667 74.666667 74.666666 74.666666h448A74.666667 74.666667 0 0 0 896 650.666667V202.666667A74.666667 74.666667 0 0 0 821.333333 128M213.333333 298.666667H128v512a85.333333 85.333333 0 0 0 85.333333 85.333333h512v-85.333333H213.333333V298.666667z" fill="#aaaeba"></path></svg>
                        <span>å¤åˆ¶</span>
                    </div>
                </div>
            </div>
        </div>`);
}

function update_bot_bubble(markdown, round_counter) {
    $(`#bot_response_${round_counter}`).html(markdown);
}

function clear_chat_record() {
    $("#ChatRecord").html("");
}

function append_chat_info(info) {
    $("#ChatRecord").append(`<div class="ChatInfo">${info}</div>`);
}

function set_input_box(content) {
    $("#input").val(content);
    $("#input").trigger("change");
}











function get_current_llm_key() {
    llm_socket.emit("get_current_llm_key");
}
llm_socket.on("get_current_llm_key_callback", function(res) {
    append_chat_info(`å½“å‰LLMï¼š${res.current_llm_key}`);
    $("#model_config").val(res.current_llm_key)
});



function submit() {
    let date_obj = new Date();
    let date_str = `${date_obj.getHours()}:${date_obj.getMinutes()}:${date_obj.getHours()}`;
    // $(".Guide").remove();

    let input_txt = $("#input").val();

    let content = input_txt.replace(/\\\(/gi, "$")
                           .replace(/\\\)/gi, "$")
                           .replace(/\\\[/gi, "$$$")
                           .replace(/\\\]/gi, "$$$");
    let md = marked.parse(content);
    append_user_bubble(md, round_counter, date_str);

    CHAT_HISTORY.push({"role": "user", "content": input_txt});

    let llm_request = {
        "session_id": SESSION_ID,
        "timestamp": new Date().getTime(),
        "config": {
            "temperature": Number(temperature.getValue()),
            "top_p": Number(top_p.getValue()),
            "top_k": Number(top_k.getValue()),
        },
        "chatml": CHAT_HISTORY
    };

    console.log(llm_request);

    llm_socket.emit("submit", llm_request);
    switch_submit_button_state("interrupt");

    set_input_box("");

    MathJax.startup.defaultPageReady();
    scroll_to_bottom();
}

function interrupt() {
    append_chat_info("æ‰‹åŠ¨ä¸­æ–­");
    llm_socket.emit("interrupt", {});
    scroll_to_bottom();
}

let start_generating_timestamp = 0;
let end_generating_timestamp = 0;
let char_count = 0;

llm_socket.on("chat_response", function(msg) {
    let date_obj = new Date();
    let date_str = `${date_obj.getHours()}:${date_obj.getMinutes()}:${date_obj.getHours()}`;
    if(msg.status === "start") {
        start_generating_timestamp = new Date().getTime();
        append_bot_bubble(round_counter, date_str);
        scroll_to_bottom();
    }
    else if(msg.status === "generating") {
        switch_submit_button_state("interrupt");
        let llm_output = msg.llm_output;
        let content = llm_output.content.replace(/\\\(/gi, "$")
                                        .replace(/\\\)/gi, "$")
                                        .replace(/\\\[/gi, "$$$")
                                        .replace(/\\\]/gi, "$$$")
                                        .replace(/\~/gi, "ï½");
        let md = marked.parse(content);
        char_count = content.length;
        update_bot_bubble(md, round_counter);
        MathJax.startup.defaultPageReady();
        scroll_to_bottom();
    }
    else if(msg.status === "end") {
        end_generating_timestamp = new Date().getTime();
        CHAT_HISTORY.push(msg.llm_output)
        switch_submit_button_state("submit");
        let cps = char_count / (end_generating_timestamp - start_generating_timestamp) * 1000;
        append_chat_info(`ç”Ÿæˆé€Ÿåº¦ï¼š${cps.toFixed()}å­—ç¬¦/ç§’`);
        round_counter++; return;
    }
});


llm_socket.on("change_llm_response", function(res) {
    if(res.is_success == true) {
        append_chat_info(res.message);
        $(`.ModelItem`).removeClass(`ChosenItem`);
        $(`#model_${res.model_index}`).addClass(`ChosenItem`);
    }
    else {
        append_chat_info(res.message);
    }
    modal.hide();
    $(".ModalThrobberContainer").css("display", "none");
});










$("#submit").click(function(event) {
    if($('#submit').hasClass("ButtonInterrupt") === true) {
        interrupt();
        return false;
    }
    else {
        submit();
        return false;
    }
});

$("#input").on("keydown", function(e) {
    if(e.shiftKey && e.keyCode === 13) {
        if($('#submit').hasClass("ButtonInterrupt") === true) {
            interrupt();
            return false;
        }
        else {
            submit();
            return false;
        }
    }
});

$("#input").on("input propertychange change keydown", function(e) {
    $(this).innerHeight(10);
    $(this).innerHeight(this.scrollHeight);
});


$("#clear_input_box").on("click", function() {
    set_input_box("");
});

$("#setting").on("click", function() {
    modal.toggle();
});

$("#reset").on("click", function() {
    interrupt();
    CHAT_HISTORY = [{"role": "system", "content": SYSTEM_PROMPT_CONTENT}];
    clear_chat_record();
    append_chat_info("å¯¹è¯å†å²å·²æ¸…é™¤");
});

$(".GuideQuestion").each(function(i, elem) {
    $(elem).on("click", function(event) {
        let question = $(this).text();
        set_input_box(question);
    });
});

$("#modal_confirm").on("click", function() {
    $(".ModalThrobberContainer").css("display", "flex");
    SYSTEM_PROMPT_CONTENT = $("#system_prompt").val();
    CHAT_HISTORY[0] = {"role": "system", "content": SYSTEM_PROMPT_CONTENT};
    let llm_config_key = $("#model_config").val();
    console.log(llm_config_key);
    llm_socket.emit("change_llm", {"llm_config_key": llm_config_key});
});

$("#modal_cancel").on("click", function() {
    modal.hide();
});














let ptt_is_pushing = false;

let ptt_timestamp = 0;

$("#ptt").on("mousedown touchstart", function(event) {
    $("#ptt").addClass("ButtonPTT_Active");
    ptt_timestamp = new Date().getTime();
    funasr.connect();
    funasr.start_recording();
});

$("#ptt").on("mouseup touchend", function(event) {
    $("#ptt").removeClass("ButtonPTT_Active");
    let current_timestamp = new Date().getTime();
    if(current_timestamp - ptt_timestamp < 1000) {
        console.log("PTTæŒ‰ä½æ—¶é—´çŸ­äº1ç§’");
    }
    funasr.disconnect();
    funasr.stop_recording();
    $("#submit").click();
});



















layout_init();

let layoutObserver = new MutationObserver((mutations, observer) => {
    let media_type = GetMediaType();
    if(media_type === "Desktop") {
        layout_refresh(300);
    }
    else if(media_type === "Mobile") {
        layout_refresh(0);
    }
});
layoutObserver.observe(document.getElementsByTagName('html')[0], {attributes: true, characterData: true, childList: true, subtree: true});

get_current_llm_key();

</script>

</body>
</html>
